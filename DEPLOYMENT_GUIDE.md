# Cyber Khana CTF Platform - DigitalOcean Deployment Guide

## Overview
This guide will help you deploy the entire CTF platform on DigitalOcean including:
- Main CTF Platform (Backend + Frontend)
- MongoDB Database
- Vulnerable Machines (separate droplets)

## Prerequisites
- DigitalOcean account
- Domain name (optional but recommended)
- Basic knowledge of Linux commands

## Architecture

```
┌─────────────────────────────────────────────────────────┐
│                    DigitalOcean                          │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  ┌──────────────────┐  ┌──────────────────┐             │
│  │  Main Platform   │  │   MongoDB DB     │             │
│  │  (VPS - $12/mo)  │  │  (VPS - $6/mo)   │             │
│  │  1GB RAM / 1CPU  │  │  1GB RAM / 1CPU  │             │
│  └──────────────────┘  └──────────────────┘             │
│                                                          │
│  ┌──────────────────┐  ┌──────────────────┐             │
│  │ Vulnerable VM 1  │  │ Vulnerable VM 2  │             │
│  │ (VPS - $6/mo)    │  │ (VPS - $6/mo)    │             │
│  │ 1GB RAM / 1CPU   │  │ 1GB RAM / 1CPU   │             │
│  └──────────────────┘  └──────────────────┘             │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

## Step 1: Create DigitalOcean Droplets

### 1.1 Create Main Platform Droplet
```bash
# In DigitalOcean Dashboard:
# - Click "Create" > "Droplets"
# - Choose: Ubuntu 22.04 LTS x64
# - Plan: Basic ($12/month - 1GB RAM, 1 vCPU, 25GB SSD)
# - Add your SSH key
# - Hostname: ctf-platform-main
```

### 1.2 Create MongoDB Database Droplet
```bash
# Click "Create" > "Droplets"
# - Choose: Ubuntu 22.04 LTS x64
# - Plan: Basic ($6/month - 1GB RAM, 1 vCPU, 25GB SSD)
# - Add your SSH key
# - Hostname: ctf-platform-db
```

### 1.3 Create Vulnerable Machine Droplets (Optional)
```bash
# For each vulnerable machine you want to host:
# - Create a separate droplet
# - Choose: Ubuntu 22.04 LTS x64
# - Plan: Basic ($6/month - 1GB RAM, 1 vCPU, 25GB SSD)
# - Hostname: ctf-vm-1, ctf-vm-2, etc.
```

## Step 2: Setup Main Platform Droplet

### 2.1 Connect to Droplet
```bash
ssh root@YOUR_DROPLET_IP
```

### 2.2 Update System
```bash
apt update && apt upgrade -y
apt install -y curl wget git nginx certbot python3-certbot-nginx ufw
```

### 2.3 Install Node.js
```bash
curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
apt install -y nodejs
node --version
npm --version
```

### 2.4 Install PM2 (Process Manager)
```bash
npm install -g pm2
```

### 2.5 Clone Your Repository
```bash
# Navigate to the directory where you want to deploy
cd /var/www
git clone https://github.com/YOUR_USERNAME/YOUR_REPO_NAME.git ctf-platform

# Or upload via scp:
# scp -r ./backend user@YOUR_IP:/var/www/ctf-platform/
# scp -r ./frontend user@YOUR_IP:/var/www/ctf-platform/
```

### 2.6 Setup Backend
```bash
cd /var/www/ctf-platform/backend
npm install --production

# Create environment file
cat > .env << 'EOF'
NODE_ENV=production
PORT=5001
MONGODB_URI=mongodb://YOUR_DB_DROPLET_IP:27017/ctf-platform
JWT_SECRET=your_super_secret_jwt_key_here_change_in_production
ADMIN_USERNAME=admin
ADMIN_PASSWORD=admin123
UNIVERSITY_CODE=SUPER
EOF

# Set production environment
export NODE_ENV=production
```

### 2.7 Setup Frontend
```bash
cd /var/www/ctf-platform/frontend

# Install dependencies
npm install

# Create production build
npm run build

# Create .env file
cat > .env.production << 'EOF'
VITE_API_URL=https://yourdomain.com/api
EOF
```

### 2.8 Configure Nginx
```bash
# Create Nginx configuration
cat > /etc/nginx/sites-available/ctf-platform << 'EOF'
server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;

    # Redirect HTTP to HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name yourdomain.com www.yourdomain.com;

    # SSL Configuration (will be auto-generated by certbot)
    # ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;

    # Frontend (React build)
    location / {
        root /var/www/ctf-platform/frontend/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # API Backend
    location /api/ {
        proxy_pass http://localhost:5001/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
EOF

# Enable the site
ln -s /etc/nginx/sites-available/ctf-platform /etc/nginx/sites-enabled/

# Test nginx configuration
nginx -t
```

## Step 3: Setup MongoDB Droplet

### 3.1 Connect to DB Droplet
```bash
ssh root@YOUR_DB_DROPLET_IP
```

### 3.2 Update System
```bash
apt update && apt upgrade -y
```

### 3.3 Install MongoDB
```bash
curl -fsSL https://www.mongodb.org/static/pgp/server-6.0.asc | apt-key add -
echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/6.0 multiverse" | tee /etc/apt/sources.list.d/mongodb-org-6.0.list

apt update
apt install -y mongodb-org

# Start and enable MongoDB
systemctl start mongod
systemctl enable mongod

# Verify installation
systemctl status mongod
```

### 3.4 Configure MongoDB
```bash
# Edit MongoDB configuration to allow external connections
nano /etc/mongod.conf

# Change bindIp from 127.0.0.1 to 0.0.0.0
# bindIp: 0.0.0.0

# Restart MongoDB
systemctl restart mongod
```

### 3.5 Setup Firewall
```bash
ufw allow 22/tcp
ufw allow 27017/tcp
ufw --force enable

# Restrict SSH access to your IP (optional but recommended)
# ufw allow from YOUR_IP to any port 22
```

## Step 4: Setup Vulnerable Machines

### 4.1 Create Separate Droplets for Each VM
```bash
# For each vulnerable machine:
# - Create Ubuntu 22.04 droplet
# - Install necessary services
```

### 4.2 Example: Deploy Metasploitable2 VM
```bash
# This is a simplified example - in production, you'd use:
# - Docker containers with vulnerable applications
# - Pre-configured VM images
# - Network isolation

# Install Docker on the vulnerable VM droplet
apt update
apt install -y docker.io
systemctl start docker
systemctl enable docker

# Example: Run a vulnerable web application
docker pull ismisepaul/securityshepherd
docker run -d -p 80:80 ismisepaul/securityshepherd

# Example: Metasploitable
docker pull tleemcjr/metasploitable2
docker run -d -p 23:23 -p 80:80 -p 139:139 -p 445:445 tleemcjr/metasploitable2
```

## Step 5: SSL Certificate Setup

### 5.1 On Main Platform Droplet
```bash
# Get SSL certificate
certbot --nginx -d yourdomain.com -d www.yourdomain.com

# Update nginx config to use SSL (certbot does this automatically)
# Set auto-renewal
crontab -e
# Add: 0 12 * * * /usr/bin/certbot renew --quiet
```

## Step 6: Start Services

### 6.1 Start Backend with PM2
```bash
cd /var/www/ctf-platform/backend
pm2 start ecosystem.config.js

# Or start manually:
# pm2 start npm --name "ctf-backend" -- start

# Save PM2 configuration
pm2 save
pm2 startup
```

### 6.2 Create PM2 Ecosystem File
```bash
cat > /var/www/ctf-platform/backend/ecosystem.config.js << 'EOF'
module.exports = {
  apps: [{
    name: 'ctf-platform-backend',
    script: './src/index.js',
    instances: 1,
    exec_mode: 'fork',
    env: {
      NODE_ENV: 'production',
      PORT: 5001
    }
  }]
};
EOF
```

### 6.3 Restart Nginx
```bash
systemctl restart nginx
systemctl enable nginx
```

## Step 7: Update Database IP

### 7.1 Update Main Platform .env
```bash
cd /var/www/ctf-platform/backend
nano .env

# Update MONGODB_URI with your DB droplet IP
MONGODB_URI=mongodb://YOUR_DB_DROPLET_IP:27017/ctf-platform
```

### 7.2 Restart Backend
```bash
pm2 restart ctf-platform-backend
```

## Step 8: Initial Setup

### 8.1 Setup Initial Admin
```bash
# Access your website at https://yourdomain.com
# Login with default credentials from .env file
# Change admin password immediately
```

## Step 9: Create Backup Strategy

### 9.1 Database Backup
```bash
# On DB Droplet
#!/bin/bash
BACKUP_DIR="/root/mongodb-backups"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

mongodump --out $BACKUP_DIR/backup_$DATE

# Keep only last 7 days of backups
find $BACKUP_DIR -type d -mtime +7 -exec rm -rf {} \;

# Add to crontab for daily backups
crontab -e
# 0 2 * * * /path/to/backup-script.sh
```

## Step 10: Security Hardening

### 10.1 Configure Firewall (Main Platform)
```bash
ufw default deny incoming
ufw default allow outgoing
ufw allow 22/tcp      # SSH
ufw allow 80/tcp      # HTTP
ufw allow 443/tcp     # HTTPS
ufw allow 5001/tcp    # Backend API (if accessing directly)
ufw --force enable

# Optional: Restrict SSH to your IP
# ufw allow from YOUR_IP to any port 22
```

### 10.2 Disable Root Login
```bash
# On all droplets
# Edit SSH config
nano /etc/ssh/sshd_config

# Set:
PermitRootLogin no
PasswordAuthentication no
PubkeyAuthentication yes

# Restart SSH
systemctl restart ssh
```

### 10.3 Setup Fail2Ban
```bash
# On Main Platform
apt install -y fail2ban

# Create config
cat > /etc/fail2ban/jail.local << 'EOF'
[DEFAULT]
bantime = 3600
findtime = 600
maxretry = 3

[sshd]
enabled = true

[nginx-http-auth]
enabled = true
filter = nginx-http-auth
logpath = /var/log/nginx/error.log
maxretry = 3
EOF

systemctl enable fail2ban
systemctl start fail2ban
```

## Step 11: Monitoring

### 11.1 Install htop
```bash
apt install -y htop
```

### 11.2 Setup Log Monitoring
```bash
# View logs
pm2 logs ctf-platform-backend
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log
```

## Step 12: Troubleshooting

### 12.1 Check Backend Status
```bash
pm2 status
pm2 logs ctf-platform-backend
```

### 12.2 Check MongoDB
```bash
systemctl status mongod
mongosh
> show dbs
```

### 12.3 Check Nginx
```bash
nginx -t
systemctl status nginx
```

## Step 13: Production Checklist

- [ ] Change default admin credentials
- [ ] Change JWT secret
- [ ] Set strong passwords
- [ ] Configure SSL certificates
- [ ] Setup database backups
- [ ] Configure firewall rules
- [ ] Install and configure Fail2Ban
- [ ] Update MongoDB authentication (create admin user)
- [ ] Setup monitoring
- [ ] Test all features
- [ ] Setup domain name
- [ ] Configure email (optional)

## Estimated Monthly Costs

- Main Platform (1GB RAM, 1 vCPU): $12
- MongoDB Database (1GB RAM, 1 vCPU): $6
- Each Vulnerable VM (1GB RAM, 1 vCPU): $6
- **Total for 2 VMs**: $24/month
- **Total for 5 VMs**: $42/month

## Additional Resources

- DigitalOcean Documentation: https://docs.digitalocean.com/
- MongoDB Security Checklist: https://docs.mongodb.com/manual/administration/security-checklist/
- Nginx Configuration: https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/
- PM2 Documentation: https://pm2.keymetrics.io/docs/usage/quick-start/

## Scaling Considerations

### If you need more resources:
- **Platform**: Upgrade to 2GB or 4GB RAM
- **Database**: Upgrade to 2GB RAM or use MongoDB Atlas
- **Load Balancer**: Use DigitalOcean Load Balancer for multiple instances

### For High Availability:
- Setup multiple droplets behind a load balancer
- Use DigitalOcean Managed MongoDB
- Setup database replication
- Configure session storage (Redis)

## Support

For issues with:
- DigitalOcean: https://community.digitalocean.com/
- MongoDB: https://www.mongodb.com/community/support
- Nginx: https://nginx.org/en/support.html
